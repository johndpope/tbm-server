box: zazo/rails

build:
  services:
    - id: mysql
      tag: 5.7
      env:
        MYSQL_USER: users_db
        MYSQL_PASSWORD: secret888zazo
        MYSQL_DATABASE: users_db
        MYSQL_ROOT_PASSWORD: secret888zazo
  steps:
    - bundle-install:
        gemfile: config/Gemfile
        without: development production
    - script:
        name: db setup
        code: rake db:create db:migrate RAILS_ENV=test
    - script:
        name: create rspec and coverage dir
        code: mkdir -p $WERCKER_REPORT_ARTIFACTS_DIR/rspec $WERCKER_REPORT_ARTIFACTS_DIR/coverage
    - script:
        name: rspec
        code: rspec
  after-steps:
    - slack-notifier:
        url: $SLACK_URL
        channel: devops
        username: Wercker

deploy:
  steps:
    - asux/elastic-beanstalk-deploy:
        key: $AWS_ACCESS_KEY_ID
        secret: $AWS_SECRET_ACCESS_KEY
        app_name: $EB_APP
        env_name: $EB_ENV
        region: $AWS_REGION
  after-steps:
    - akelmanson/rollbar-notify:
        access-token: $rollbar_access_token
    - rafaelverger/newrelic-deployment:
        api_key: $newrelic_api_key
        app_name: $app_name ($WERCKER_DEPLOYTARGET_NAME)
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_URL
