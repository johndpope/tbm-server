box: wercker/rvm

services:
  - wercker/mysql

build:
  steps:
    - bundle-install:
        gemfile: config/Gemfile
        without: development production
    - asux/rails-database-yml:
        mysql-collation: utf8_unicode_ci
    - script:
        name: echo ruby information
        code: |
          echo "ruby version $(ruby --version) running"
          echo "from location $(which ruby)"
          echo -p "gem list: $(gem list)"
    - script:
        name: reset database
        code: bin/rake db:drop db:create db:migrate
    - script:
        name: create rspec and coverage dir
        code: mkdir -p $WERCKER_REPORT_ARTIFACTS_DIR/rspec $WERCKER_REPORT_ARTIFACTS_DIR/coverage
    - script:
        name: rspec
        code: bundle exec rspec
  after-steps:
    - wantedly/pretty-slack-notify:
        webhook_url: $slack_url

deploy:
  steps:
    - asux/elastic-beanstalk-deploy:
        key: $AWS_ACCESS_KEY_ID
        secret: $AWS_SECRET_ACCESS_KEY
        app_name: $EB_APP
        env_name: $EB_ENV
        region: $AWS_REGION
  after-steps:
    - akelmanson/rollbar-notify:
        access-token: $rollbar_access_token
    - rafaelverger/newrelic-deployment:
        api_key: $newrelic_api_key
        app_name: $app_name ($WERCKER_DEPLOYTARGET_NAME)
    - wantedly/pretty-slack-notify:
        webhook_url: $slack_url
